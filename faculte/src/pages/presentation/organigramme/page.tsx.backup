import { motion, AnimatePresence } from "framer-motion"
import React, { useState } from "react";
import { ChevronDown, ChevronRight, User, Mail, Phone, Building, ChevronUp, MapPin } from "lucide-react";

interface Person {
  name: string;
  title: string;
  phone: string;
  email: string;
  office: string;
}

interface PersonCardProps {
  person: Person;
  personKey: string;
  bgColor: string;
  textColor: string;
  hoverColor: string;
}

interface OrgNodeType {
  name: string;
  title: string;
  person?: {
    firstName: string;
    lastName: string;
    email: string;
    phone: string;
    building: string;
    photo: string;
    bio?: string;
  };
  children?: OrgNodeType[];
}

export default function OrganigrammePage() {
  const [selectedPerson, setSelectedPerson] = useState<string | null>(null)

  const orgData = {
    name: "COFAC",
    title: "Faculté",
    person: {
      firstName: "Dr. Marie",
      lastName: "RASOANAIVO",
      email: "marie.rasoanaivo@cofac.mg",
      phone: "+261 34 12 345 67",
      building: "Bâtiment Principal",
      photo: "/api/placeholder/60/60",
      bio: "Dr. Marie RASOANAIVO est doyenne de COFAC depuis 2018 et spécialisée en sciences de l’éducation."
    },
    children: [
      {
        name: "Doyen",
        title: "Direction",
        person: {
          firstName: "Prof. Jean",
          lastName: "RAKOTOMANGA",
          email: "doyen@cofac.mg",
          phone: "+261 34 11 111 11",
          building: "Bâtiment Administration",
          photo: "/api/placeholder/60/60",
          bio: "Dr. Marie RASOANAIVO est doyenne de COFAC depuis 2018 et spécialisée en sciences de l’éducation."
        },
        children: [
          { 
            name: "Conseil scientifique",
            title: "Conseil",
            person: {
              firstName: "Dr. Paul",
              lastName: "ANDRIAMAMY",
              email: "conseil.scientifique@cofac.mg",
              phone: "+261 34 22 222 22",
              building: "Bâtiment Recherche",
              photo: "/api/placeholder/60/60",
              bio: "Dr. Marie RASOANAIVO est doyenne de COFAC depuis 2018 et spécialisée en sciences de l’éducation."
            }
          },
          { 
            name: "Collège des enseignants",
            title: "Enseignement",
            person: {
              firstName: "Dr. Sophie",
              lastName: "RAZAFY",
              email: "college.enseignants@cofac.mg",
              phone: "+261 34 33 333 33",
              building: "Bâtiment Pédagogie",
              photo: "/api/placeholder/60/60",
              bio: "Dr. Marie RASOANAIVO est doyenne de COFAC depuis 2018 et spécialisée en sciences de l’éducation."
            }
          },
          {
            name: "Mention",
            title: "Formation",
            person: {
              firstName: "Dr. Michel",
              lastName: "RABE",
              email: "mention@cofac.mg",
              phone: "+261 34 44 444 44",
              building: "Bâtiment Formation",
              photo: "/api/placeholder/60/60",
              bio: "Dr. Marie RASOANAIVO est doyenne de COFAC depuis 2018 et spécialisée en sciences de l’éducation."
            },
            children: [
              {
                name: "Parcours",
                title: "Spécialisation",
                person: {
                  firstName: "Dr. Anne",
                  lastName: "RATIARISON",
                  email: "parcours@cofac.mg",
                  phone: "+261 34 55 555 55",
                  building: "Bâtiment Formation",
                  photo: "/api/placeholder/60/60",
                  bio: "Dr. Marie RASOANAIVO est doyenne de COFAC depuis 2018 et spécialisée en sciences de l’éducation."
                },
                children: [
                  { 
                    name: "Labo",
                    title: "Laboratoire",
                    person: {
                      firstName: "Dr. Pierre",
                      lastName: "RANDRIA",
                      email: "labo@cofac.mg",
                      phone: "+261 34 66 666 66",
                      building: "Bâtiment Laboratoire",
                      photo: "/api/placeholder/60/60",
                      bio: "Dr. Marie RASOANAIVO est doyenne de COFAC depuis 2018 et spécialisée en sciences de l’éducation."
                    }
                  }
                ],
              },
            ],
          },
          { 
            name: "DICOS",
            title: "Service",
            person: {
              firstName: "Mme. Claire",
              lastName: "RAKOTO",
              email: "dicos@cofac.mg",
              phone: "+261 34 77 777 77",
              building: "Bâtiment Services",
              photo: "/api/placeholder/60/60",
              bio: "Dr. Marie RASOANAIVO est doyenne de COFAC depuis 2018 et spécialisée en sciences de l’éducation."
            }
          },
          {
            name: "Secrétaire principal",
            title: "Administration",
            person: {
              firstName: "M. Robert",
              lastName: "RATSIMBA",
              email: "secretaire.principal@cofac.mg",
              phone: "+261 34 88 888 88",
              building: "Bâtiment Administration",
              photo: "/api/placeholder/60/60",
              bio: "Dr. Marie RASOANAIVO est doyenne de COFAC depuis 2018 et spécialisée en sciences de l’éducation."
            },
            children: [
              { 
                name: "Service de la scolarité",
                title: "Scolarité",
                person: {
                  firstName: "Mme. Hery",
                  lastName: "RAJAO",
                  email: "scolarite@cofac.mg",
                  phone: "+261 34 99 999 99",
                  building: "Bâtiment Administration",
                  photo: "/api/placeholder/60/60",
                  bio: "Dr. Marie RASOANAIVO est doyenne de COFAC depuis 2018 et spécialisée en sciences de l’éducation."
                }
              },
              { 
                name: "Service des affaires générales",
                title: "Affaires générales",
                person: {
                  firstName: "M. David",
                  lastName: "RAZANA",
                  email: "affaires.generales@cofac.mg",
                  phone: "+261 34 10 101 01",
                  building: "Bâtiment Administration",
                  photo: "/api/placeholder/60/60",
                  bio: "Dr. Marie RASOANAIVO est doyenne de COFAC depuis 2018 et spécialisée en sciences de l’éducation."
                }
              },
              { 
                name: "Service du personnel",
                title: "Ressources humaines",
                person: {
                  firstName: "Mme. Nadia",
                  lastName: "RANAIVO",
                  email: "personnel@cofac.mg",
                  phone: "+261 34 12 121 21",
                  building: "Bâtiment Administration",
                  photo: "/api/placeholder/60/60",
                  bio: "Dr. Marie RASOANAIVO est doyenne de COFAC depuis 2018 et spécialisée en sciences de l’éducation."
                }
              },
              { 
                name: "Service de la comptabilité",
                title: "Finance",
                person: {
                  firstName: "M. Eric",
                  lastName: "RABARY",
                  email: "comptabilite@cofac.mg",
                  phone: "+261 34 13 131 31",
                  building: "Bâtiment Administration",
                  photo: "/api/placeholder/60/60",
                  bio: "Dr. Marie RASOANAIVO est doyenne de COFAC depuis 2018 et spécialisée en sciences de l’éducation."
                }
              },
              { 
                name: "Service informatique",
                title: "IT",
                person: {
                  firstName: "M. Luc",
                  lastName: "RAJERY",
                  email: "informatique@cofac.mg",
                  phone: "+261 34 14 141 41",
                  building: "Bâtiment Technique",
                  photo: "/api/placeholder/60/60",
                  bio: "Dr. Marie RASOANAIVO est doyenne de COFAC depuis 2018 et spécialisée en sciences de l’éducation."
                }
              },
            ],
          },
          {
            name: "Vice-Doyens",
            title: "Direction adjointe",
            person: {
              firstName: "Coordination",
              lastName: "Vice-Doyens",
              email: "vice.doyens@cofac.mg",
              phone: "+261 34 15 151 51",
              building: "Bâtiment Administration",
              photo: "/api/placeholder/60/60",
              bio: "Dr. Marie RASOANAIVO est doyenne de COFAC depuis 2018 et spécialisée en sciences de l’éducation."
            },
            children: [
              {
                name: "Vice Doyen chargé de la formation",
                title: "Formation",
                person: {
                  firstName: "Dr. Alice",
                  lastName: "RAMASY",
                  email: "vd.formation@cofac.mg",
                  phone: "+261 34 16 161 61",
                  building: "Bâtiment Pédagogie",
                  photo: "/api/placeholder/60/60",
                  bio: "Dr. Marie RASOANAIVO est doyenne de COFAC depuis 2018 et spécialisée en sciences de l’éducation."
                },
                children: [
                  { 
                    name: "Associations des étudiants",
                    title: "Vie étudiante",
                    person: {
                      firstName: "M. Kevin",
                      lastName: "RATOVO",
                      email: "associations@cofac.mg",
                      phone: "+261 34 17 171 71",
                      building: "Bâtiment Étudiant",
                      photo: "/api/placeholder/60/60",
                      bio: "Dr. Marie RASOANAIVO est doyenne de COFAC depuis 2018 et spécialisée en sciences de l’éducation."
                    }
                  }
                ],
              },
              {
                name: "Vice Doyen chargé de la réforme numérique et base de données",
                title: "Numérique",
                person: {
                  firstName: "Dr. Thomas",
                  lastName: "RAZAKA",
                  email: "vd.numerique@cofac.mg",
                  phone: "+261 34 18 181 81",
                  building: "Bâtiment Technique",
                  photo: "/api/placeholder/60/60",
                  bio: "Dr. Marie RASOANAIVO est doyenne de COFAC depuis 2018 et spécialisée en sciences de l’éducation."
                }
              },
              {
                name: "Vice Doyen chargé du Développement des partenariats et recherche",
                title: "Partenariats",
                person: {
                  firstName: "Prof. Sylvie",
                  lastName: "RANDRIANY",
                  email: "vd.partenariats@cofac.mg",
                  phone: "+261 34 19 191 91",
                  building: "Bâtiment Recherche",
                  photo: "/api/placeholder/60/60",
                  bio: "Dr. Marie RASOANAIVO est doyenne de COFAC depuis 2018 et spécialisée en sciences de l’éducation."
                }
              },
              {
                name: "Vice Doyen chargé de la communication, contrôle de gestion et de la vie sociale",
                title: "Communication",
                person: {
                  firstName: "Mme. Julie",
                  lastName: "RABENJA",
                  email: "vd.communication@cofac.mg",
                  phone: "+261 34 20 202 02",
                  building: "Bâtiment Communication",
                  photo: "/api/placeholder/60/60",
                  bio: "Dr. Marie RASOANAIVO est doyenne de COFAC depuis 2018 et spécialisée en sciences de l’éducation."
                }
              },
            ],
          },
        ],
      },
    ],
  };

  interface OrgNodeType {
    name: string;
    title?: string;
    bio?: string;
    person?: {
      firstName: string;
      lastName: string;
      email: string;
      phone: string;
      building: string;
    };
    children?: OrgNodeType[];
  }

  const getBgColor = (level: number) => {
    switch(level) {
      case 0: return "bg-white border-[var(--primary)]";
      case 1: return "bg-[var(--primary)]/10 border-[var(--primary)]";
      case 2: return "bg-[var(--secondary)]/10 border-[var(--secondary)]";
      case 3: return "bg-[var(--accent)]/10 border-[var(--accent)]";
      default: return "bg-white border-gray-200";
    }
  }

  const getTextColor = (level: number) => {
    switch(level) {
      case 0: return "text-[var(--primary)]";
      case 1: return "text-[var(--primary)]";
      case 2: return "text-[var(--secondary)]";
      case 3: return "text-[var(--accent)]";
      default: return "text-slate-800";
    }
  }

  const OrgNode = ({ node, level = 0 }: { node: OrgNodeType; level?: number }) => {
    const [isExpanded, setIsExpanded] = React.useState(level < 2);
    const [showDetails, setShowDetails] = React.useState(false);

    const hasChildren = node.children && node.children.length > 0;

    const toggleExpansion = (e: React.MouseEvent) => {
      e.stopPropagation();
      setIsExpanded(!isExpanded);
    }

    const toggleDetails = (e: React.MouseEvent) => {
      e.stopPropagation();
      setShowDetails(!showDetails);
    }

    return (
      <div className="relative w-full">
        {/* Lignes de connexion */}
        {level > 0 && (
          <div className={`hidden md:block absolute -left-6 top-0 w-px h-6 bg-[var(--border)]`}></div>
        )}
        {level > 0 && (
          <div className={`hidden md:block absolute -left-6 top-6 w-6 h-px bg-[var(--border)]`}></div>
        )}

        <div className={`mb-4 border-2 ${getBgColor(level)} shadow-md`}>
          <div className="flex items-center justify-between p-3">
            <div className="flex items-center space-x-3 flex-1 min-w-0">
              {/* Avatar */}
              <div className={`flex items-center justify-center bg-gray-200 ${level === 0 ? 'w-12 h-12' : 'w-10 h-10'}`}>
                <User className={`text-gray-600 ${level === 0 ? 'w-6 h-6' : 'w-5 h-5'}`} />
              </div>

              {/* Nom et titre */}
              <div className="flex-1 min-w-0">
                <h3 className={`font-bold truncate ${getTextColor(level)}`}>
                  {node.name}
                </h3>
                {node.title && (
                  <p className={`text-xs truncate ${getTextColor(level)}`}>{node.title}</p>
                )}
              </div>
            </div>

            {/* Boutons */}
            <div className="flex items-center space-x-2 flex-shrink-0">
              {node.person && (
                <button
                  onClick={toggleDetails}
                  className={`px-3 py-1 text-xs font-medium transition-all duration-200 ${
                    showDetails ? 'bg-[var(--secondary)]/20 text-[var(--secondary)]' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'
                  }`}
                >
                  {showDetails ? 'Masquer' : 'Détails'}
                </button>
              )}

              {hasChildren && (
                <button
                  onClick={toggleExpansion}
                  className="p-2 hover:bg-gray-100 transition-colors"
                >
                  {isExpanded ? <ChevronDown className="w-4 h-4 text-gray-600"/> : <ChevronRight className="w-4 h-4 text-gray-600"/>}
                </button>
              )}
            </div>
          </div>

          {/* Détails */}
          {showDetails && node.person && (
            <div className="border-t border-gray-200 p-3 bg-gray-50">
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
                <div className="flex items-center space-x-2">
                  <User className="w-4 h-4 text-gray-500"/>
                  <span>{node.person.firstName} {node.person.lastName}</span>
                </div>
                <div className="flex items-center space-x-2">
                  <Building className="w-4 h-4 text-gray-500"/>
                  <span>{node.person.building}</span>
                </div>
                <div className="flex items-center space-x-2">
                  <Mail className="w-4 h-4 text-gray-500"/>
                  <a href={`mailto:${node.person.email}`} className="text-blue-600 hover:text-blue-800">{node.person.email}</a>
                </div>
                <div className="flex items-center space-x-2">
                  <Phone className="w-4 h-4 text-gray-500"/>
                  <a href={`tel:${node.person.phone}`} className="text-green-600 hover:text-green-800">{node.person.phone}</a>
                </div>
                {node.bio && (
                  <div className="sm:col-span-2 text-gray-700">
                    <p>{node.bio}</p>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>

        {/* Enfants */}
        {hasChildren && isExpanded && (
            <div className="ml-0 md:ml-6 mt-4 flex flex-wrap gap-4">
             {node.children && node.children.map((child: OrgNodeType, index: number) => (
               <div className="flex-1 min-w-[250px]" key={index}>
                  <OrgNode node={child} level={level + 1} />
                </div>
              ))}
            </div>
          )}
      </div>
    )
  }



  const PersonCard = ({ person, personKey, bgColor, textColor, hoverColor }: PersonCardProps) => {
    const isSelected = selectedPerson === personKey
    
    return (
      <motion.div
        layout
        className={`${bgColor} ${hoverColor} rounded-xl shadow-md transition-all duration-300 cursor-pointer`}
        onClick={() => setSelectedPerson(isSelected ? null : personKey)}
      >
        <div className="p-4">
          <div className="flex items-center justify-between">
            <div className="flex items-center space-x-3">
              <User className={`h-6 w-6 ${textColor}`} />
              <div>
                <h4 className={`font-semibold ${textColor}`}>
                  {person.title.replace("Chef Département ", "")}
                </h4>
                <p className={`text-xs ${textColor} opacity-80`}>
                  {person.name.split(" ").slice(-1)[0]}
                </p>
              </div>
            </div>
            {isSelected ? (
              <ChevronUp className={`h-5 w-5 ${textColor}`} />
            ) : (
              <ChevronDown className={`h-5 w-5 ${textColor}`} />
            )}
          </div>
        </div>
        
        <AnimatePresence>
          {isSelected && (
            <motion.div
              initial={{ height: 0, opacity: 0 }}
              animate={{ height: "auto", opacity: 1 }}
              exit={{ height: 0, opacity: 0 }}
              transition={{ duration: 0.3 }}
              className="overflow-hidden"
            >
              <div className="px-4 pb-4 border-t border-white/20 mt-2 pt-4">
                <div className="space-y-3">
                  <div>
                    <h5 className={`font-medium ${textColor} mb-1`}>{person.name}</h5>
                    <p className={`text-sm ${textColor} opacity-90`}>{person.title}</p>
                  </div>
                  
                  <div className="space-y-2">
                    <div className="flex items-center space-x-2">
                      <Phone className={`h-4 w-4 ${textColor}`} />
                      <span className={`text-sm ${textColor}`}>{person.phone}</span>
                    </div>
                    <div className="flex items-center space-x-2">
                      <Mail className={`h-4 w-4 ${textColor}`} />
                      <span className={`text-sm ${textColor} break-all`}>{person.email}</span>
                    </div>
                    <div className="flex items-center space-x-2">
                      <MapPin className={`h-4 w-4 ${textColor}`} />
                      <span className={`text-sm ${textColor}`}>{person.office}</span>
                    </div>
                  </div>
                </div>
              </div>
            </motion.div>
          )}
        </AnimatePresence>
      </motion.div>
    )
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-gray-50 via-white to-gray-100">
      <main className="pt-20 sm:pt-24 pb-12 sm:pb-16">
        <div className="container mx-auto px-4 sm:px-6 lg:px-8">
          <div className="mx-auto">
            
            {/* Header */}
            {/* Header avec image de fond - Responsive */}
            <motion.div
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ duration: 0.6 }}
                className="relative mb-12 sm:mb-16 overflow-hidden"
            >
              <div className="absolute inset-0">
                <img 
                  src="/modern-university-campus-with-science-buildings-an.png" 
                  alt="Histoire de la faculté" 
                  className="w-full h-64 sm:h-80 lg:h-96 object-cover"
                />
                <div className="absolute inset-0 bg-gradient-to-r from-white-900/80 via-gray-800/60"></div>
              </div>
              <div className="relative z-10 text-center py-10 sm:py-16 lg:py-20 px-4 sm:px-6">
                <h1 className="text-3xl sm:text-4xl lg:text-5xl font-bold mb-4 sm:mb-6 text-white">
                  Structure Organisationnelle
                </h1>
                <p className="text-base sm:text-lg lg:text-xl text-purple-100 max-w-3xl mx-auto leading-relaxed">
                  Cliquez sur les éléments pour découvrir les informations de notre équipe dirigeante
                </p>
              </div>
            </motion.div>

            {/* Organigramme interactif */}
            <div className="bg-white shadow-accent p-8">
              <OrgNode node={orgData} level={0} />
            </div>

          </div>
        </div>
      </main>
    </div>
  )
}

